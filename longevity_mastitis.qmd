---
title: "Causal analysis of the relationship between mastitis and longevity in dairy cows"
author: "Aur√©lien Madouasse"
format: html
bibliography: references.bib
---

```{r setup}
library(tidyverse)
library(ggdag)
library(DairyHerdData)
library(ggplot2)
library(scales)
library(questionr)
library(gmodels)
library(lme4)
```

# Introduction

In broad terms, longevity is the length of the life of an animal, although a wide variety of indicators can be used to measure it. A recent study by @dallago2021 provided evidence of a decrease in dairy cows' longevity between the 1960s and 2010s in the top 10 high milk-producing countries.

The departure of a cow from her herd is called culling [@fetrow2006]. In some cases, the farmer has no other choice than to cull a cow, in case of death or when the cow is not pregnant and does not give enough milk anymore to be kept in the herd. This is usually called involuntary culling. In other cases, farmers choose to cull the cows for various reasons, mostly for the presence of a disease. This is called voluntary culling. The main documented causes of culling are reproductive failure, mastitis and lameness.

Improving dairy cows' longevity therefore requires to act on the causes of culling. For example, if a disease is reported as a cause for culling, preventing the disease from occurring should increase longevity. However, this is a notably hard task. The decision of culling a cow may depend on several combined causes that are related to the status of a given animal as well as on the farm context. Furthermore, disease incidence may be increased by the presence of risk factors, and, disease occurrence can also act on factors such as milk production or reproduction that are sufficient reasons for culling. Lastly, for contagious diseases, culling infected cows could reduce the incidence of the disease by removing sources of infection from the herd.

Our objective in this paper is to analyse longevity and disease occurrence in a causal framework, using mastitis in dairy cows as an example.

# Introduction

## Causal framework

Determining what causes what is an important question in many fields. Philosophers and scientists have come up with various ways of addressing it. In quantitative disciplines such as epidemiology, economics and sociology, the 2 paradigms currently in use are the *potential outcomes framework* who is associated with Donald Rubin [@rubin1974] and *structural causal models* proposed by Judea Pearl [@pearl2009]. Although the 2 paradigms seem to differ in important ways [@markus2021], they are sometimes presented as part of a single causality framework in textbooks [@neal2020; @cunningham2021]. In what follows, we frame our problem using the potential outcomes framework and then decompose it using directed acyclic graphs, most commonly associated with the structural causal framework. Our objectives are to make sound causal inference while keeping the presentation of our research questions to the readers as clear as possible.

## Potential outcomes framework

Estimating the causal effect of the occurrence of an event on an outcome requires to be able to compare the outcome values with and without the event. For example, estimating the effect of mastitis occurrence on the probability of culling in a given cow would require to be able to observe the same cow with and without mastitis and record whether she is culled or not following the disease or its absence. Such data is of course impossible to obtain. This is in fact called *the fundamental problem of causal inference*. But laying out the problem in these terms can help to clarify the research questions, design experiments, analyse the data and interpret the results. @hernan2024 describe in simple terms and introduce notation for the potential outcome framework, that was developed by several scientists over the course of the XX$^{th}$ century, notably Donald Rubin [@rubin1974]. Let us introduce this notation using the causal effect of mastitis on the probability of culling in a cow as an example. We consider mastitis occurrence as a binary event $A$ with $A=1$ denoting presence of mastitis and $A=0$ denoting the absence of mastitis. We are interested in what would happen in cow $i$ if she were to experience mastitis ($Y_i^{1}$) or, on the contrary, if she weren't experiencing mastitis ($Y_i^{0}$). $Y_i^{A}$ represents whether cow $i$ is culled or not at the end of her lactation, with $Y^{A=a}_i=1$ if cow $i$ is culled and $Y^{A=a}_i=0$ if cow $i$ is not culled, when event $A=a$ occurs. In a given cow, only one event $A=a$ and its associated outcome $Y^{A=a}$ can be observed. These event and outcome are called factual, and the unobserved ones are called counterfactual. The factual (realised) outcomes are encoded using the $|$ symbol. For example, $Y_i | A = 0$ is the observed outcome for cow $i$ who did not get mastitis. Problems arise when there are systematic differences in potential outcomes between treated and untreated individuals, for example if $Y^{A = 1}|A = 1 \neq Y^{A = 1}|A = 0$.

## Estimands: the quantities of interest

Estimands are quantities whose value is the answer to a precise research question. Estimands are independent of both the data available and the estimation method used for the analysis. They are used in slightly different ways in different disciplines (see for example the different perspectives in sociology in @lundberg2021a and in randomized clinical trials in @kahan2024 ). Following @lundberg2021a, the two minimum components of an estimand are a *unit-specific quantity* and a *target population* [@lundberg2021]. These authors make a further distinction between theoretical estimands which are the quantities of interest to the researchers and empirical estimands which are approximations that can be computed from observed data.

For example, if we wanted to know the causal effect of clinical mastitis in early lactation on the probability of culling before or at the end of lactation in French dairy cows, we could define the following theoretical estimand:

$$
\delta_1 = \frac{1}{n} \sum_{i=1}^n Y^{1}_i - Y^{0}_i
$$ where $n$ is the total number of cows in the French dairy cow population, $Y^1_i$ and $Y^0_i$ are binary variables taking the value 1 for cows culled at or before the end of lactation and 0 otherwise in cows with ($Y^1_i$ ) and without ($Y^0_i$) clinical mastitis in early lactation respectively. Of course, in each cow, only one of the 2 outcomes can be observed. This estimand is a risk difference, but risk ratios or odds ratios could have been used as well.

But maybe, the cows who got mastitis are different from the cows who did not, for reasons other than having experienced the disease, and therefore have a different probability of being culled. $Y^{A=a}_i|A=1$ denotes the outcome associated with having mastitis given that animal $i$ experienced mastitis. We could make the hypothesis that $Y^1_i|A=1 \neq Y^1_i|A=0$ and choose to focus our interest on cows who actually got mastitis. A theoretical estimand of interest in this situation could be: $$
\delta_2 = \frac{1}{n} \sum_{i=1}^n \left[ (Y^{1}_i|A=1) - (Y^{0}_i|A=1) \right]
$$

$\delta_1$ is called the average treatment effect (**ATE**). It is a measure of a treatment (in our case a disease) effect in the whole population. $\delta_2$ is called the average treatment effect in the treated (**ATT**). In our case, it is more relevant to consider the ATE, since our interest is in evaluating the consequences of preventing mastitis in cows who experienced the disease, not really on the whole population.

## Directed acyclic graphs

Directed acyclic graphs, commonly called **DAG**s, are graphical representations of a phenomenon which are particularly well suited to model causality. The different parts or components of the phenomenon are represented using circles called nodes. We can represent the hypothesis that mastitis ($M$) causes culling ($C$) as follows:

```{r dag1}
#| echo: false
#| fig-width: 3
#| fig-height: 1
dag1 <- dagify(
  C ~ M,
  coords = list(
    x = c(M = 0, C = 2),
    y = c(M = 0, C = 0)
  )
)

ggdag(dag1) + theme_dag()
```

where the arrow indicates causality. DAGs allow to represent complex relationships between variables. We now provide a few examples of how DAGs can be useful to get a better picture of causal relationship.

Mastitis could have both direct and indirect effects on culling. As a direct effect, a severe case of clinical mastitis can lead to the death of the cow. As an indirect effect, mastitis could compromise reproductive success. This indirect effect of mastitis is *mediated* by reproduction. One usual way of modelling such data would be to fit a logistic model with culling as the outcome and mastitis and reproduction as covariates. However, if there is an effect of mastitis on reproduction, the true causal effect of mastitis on culling by the logistic model will be underestimated, because part of if will be incorporated into the effect of reproduction on culling.

```{r dag2}
#| echo: false
#| fig-width: 3
#| fig-height: 3
dag2 <- dagify(
  C ~ M,
  R ~ M,
  C ~ R,
  coords = list(
    x = c(M = 0, C = 2, R = 1),
    y = c(M = 0, C = 0, R = -1)
  )
)

ggdag(dag2) + theme_dag()
```

## Definition of mastitis

Mastitis is an inflammation of a mammary gland, caused by an intramammary infection. Different aetiological agents are associated with differences in disease epidemiology. On the one hand, bacteria of faecal origin such as *Escherichia coli* cause short lived infections with a high rate of spontaneous cure, but often acute clinical signs. On the other hand, some bacteria, such as *Staphylococcus aureus* are adapted to survive in the mammary gland and are associated with chronic infections. In this case, the infection can last for months, with clinical signs observed on rare occasions with regards with the duration of the infection. Because bacteria are shed in the milk of infected cows for long periods, milk is more likely to serve as a reservoir of infection. These infections are therefore described as contagious. All infections result in the recruitment of immune cells in the mammary gland, that are measured on a monthly basis in herds that participate to milk recording. The measured cell concentration is called milk somatic count (**SCC**).

In this study, we chose to consider the following types of mastitis:

-   new case of contagious mastitis in early lactation: primiparous cow with at least 2 out of the first 3 milk recordings above 200 000 cells/mL or multiparous cow with the last milk recording in her previous lactation below 200 000 cells/mL and at least 2 out of the first 3 milk recordings above 200 000 cells/mL
-   environmental mastitis in early lactation

## Definition of culling

## Hypohteses and DAG

# Data analysis

Unit√© statistique = lactation Y = r√©forme \<-\> rev√™lage

Using the `DairyHerdData` package.

```{r milk-recording-ai-data}
## milk recording data
rec <- rec
## artificial insemination data
ai <- ai |> 
  mutate(ai_date = as.Date(ai_date))

## days in milk added to milk recording data
rec <- rec |> 
  mutate(dim = as.integer(ctrl_date - calv_date))

## making a list of lactations
lac <- rec |> 
  group_by(anim_id, calv_date) |> 
  summarise(lac_id = NA,
            parity = unique(parity),
            n_ctrl = length(unique(ctrl_date)),
            n_scc_high = length(scc[scc > 200]),
            n_scc_early = length(scc[dim < 91]),
            n_scc_early_high = length(scc[scc > 200 & dim < 91]),
            n_scc_late_high = length(scc[scc > 200 & dim > 91]),
            #rajout de la moyenne de la PL les 91 premiers jours de lactation
            early_plmoy = mean(milk[dim < 91])) |> 
  ungroup(anim_id)

lac$lac_id <- 1:nrow(lac)

lac <- lac |> 
  group_by(anim_id) |> 
  mutate(calv_nxt = lead(calv_date))

## first date of calving
calv_first <- min(lac$calv_date)

ai <- ai |> 
  filter(ai_date > calv_first)

ai1 <- left_join(lac |> 
                   select(anim_id, lac_id, calv_date, calv_nxt), 
                 ai |> 
                   select(herd_id, cow_id, ai_date),
                 join_by(anim_id == cow_id)) |> 
           filter(ai_date > calv_date & (ai_date < calv_nxt | is.na(calv_nxt))) |> 
  select(herd_id, anim_id, lac_id, calv_date, calv_nxt, ai_date)

ai_lac <- ai1 |> 
  arrange(lac_id, ai_date) |> 
  group_by(lac_id) |> 
  summarise(ai_N = length(unique(ai_date)),
            ai_first = min(ai_date),
            ai_last = max(ai_date),
            ai_calv_days = as.integer(unique(calv_nxt) - max(ai_date)))

lac <- left_join(lac, ai_lac)

```

# References

# Essai Joanna

@Joanna : 
- Je mets un eval = false sur certains chunks. De cette mani√®re, les chunks ne sont pas √©valu√©s quand tu ex√©cutes le fichier ('render').
- Il est recommand√© de nommer les chunks pour faciliter la lecture quand on extrait le code R.
- Eviter de modifier les jeux de donn√©es par les num√©ros de colonnes. C'est peu lisible et √ßa favorise les erreurs.
- Charger les packages en d√©but de code. Encore une fois, c'est plus lisbile. Ca √©vite de les charger plusieurs fois.



Etablissons le lien entre mammites et mise √† la reproduction (d√©cision prise par l'√©leveur). n_scc_early_high donne le nombre de contr√¥les pour lesquelles le taux de cellules est sup√©rieur √† 200 000 dans les 91 premiers jours de lactation. On va donc √©mettre l'hypoth√®se que si n \>= 2 alors la vache √† fait un √©pisode de mammite chronique et ce qu'on cherche √† savoir c'est si ce r√©sultat √† un impact sur la d√©cision par l'√©leveur d'ins√©miner sa vache.

## cr√©ation d'une colonne miserepro qui donne la valeur 1 si la vache √† √©t√© ins√©min√©e et qu'elle pr√©sente un n_scc_early_high \>= 2


-   Une variable `miserepro` est cr√©√©e. Elle vaut 1 si le nombre d'IA est sup√©rieur √† 0 ce qui signe une d√©cision de l'√©lveur de mettre la vache √† la reproduction.
- une variable `early_mamchro`  est cr√©√©e. Elle vaut 1 pour les lactations qui ont plus de 2 CCS sup√©rieures √† 200 000 cellules sur les 3 premiers contr√¥les du d√©but de lactation.

```{r miserepro-early_mamchro-definition}
lac <- lac |> 
  mutate(miserepro = ifelse(ai_N == 0 | is.na(ai_N), 0, 1),
         early_mamchro = ifelse(n_scc_early_high >= 2, 1, 0))
```

## cr√©ation d'un nouveau tableau avec que les animaux atteints de mammites chronique dans les premiers 91 jours de lactation

Je pense que tu veux le tableau suivant :
--> il y a un probl√®me avec ce tableau les valeurs de mise √† la repro ne correspondent pas √† celles du tableau lac

```{r}
#comparaison de la mise √† la reproduction selon la pr√©sence ou non d'une mammite chronique en d√©but de lactation
tab_repro_mam <- lac |> 
  select(miserepro, early_mamchro) |> 
  table()
  head(tab_repro_mam)
```
je me suis permise d'en cr√©er un nouveau pour refaire un essai : 


```{r}
tab_repro_mam_1 <- lac |> 
  select(miserepro,early_mamchro) |> 
  mutate(miserepro = as.factor(miserepro), early_mamchro = as.factor(early_mamchro))
```

```{r}
p<-ggplot(tab_repro_mam_1) +
aes(x = early_mamchro, fill = miserepro) +
geom_bar(position="fill") +
xlab("mise √† la repro selon mammite chronique ou non") +
ylab("Proportion") +
labs(fill = "miserepro")
p+theme_bw()
```


Ci-dessous, les proportions de vaches mises √† la repro en fonction de la pr√©sence d'une mammite chronique. La relation est conforme √† ce qui est attendu. Utilisation d'une fonction apply. Je pourrai t'expliquer comment √ßa fonctionne.

--> je ne comprend pas ce que ce chunk est cens√© faire. Si j'ai bien compris la fonction apply() applique la m√™me fonction a tout les √©lements d'une ligne ou d'une colonne. Mais pourquoi faire la proportion de vaches mises √† la repro pour chaque colonne ? 

```{r}
apply(tab_repro_mam, 2, function(x) round(x / sum(x), 5))
```


On remarque que sur les vaches qui pr√©sentent une mammite chronique pr√©coce, 74% des vaches sont quand m√™me mises √† la reproduction.

on veut savoir s'il y a un lien entre la pr√©sence ou non de mammite et la mise √† la reproduction (attention on ne met pas en √©vidence une relation de cause √† effet)


```{r}
#
tab1 <- table(lac$miserepro, lac$early_mamchro)
tab1
lprop(tab1)
```

```{r}
CrossTable(lac$miserepro, lac$early_mamchro, digits=3, max.width = 5,
expected=FALSE, prop.r=TRUE, prop.c=TRUE,
prop.t=TRUE, prop.chisq=FALSE, chisq = FALSE, fisher=FALSE, mcnemar=FALSE,
resid=FALSE, sresid=FALSE, asresid=FALSE,
missing.include=FALSE, format=c("SAS","SPSS"))
```

```{r}
CrossTable(lac$early_mamchro,lac$miserepro, digits=3, max.width = 5,
prop.t=FALSE, prop.chisq=FALSE, chisq = TRUE, fisher=FALSE, mcnemar=FALSE,
expected=TRUE, prop.r=FALSE, prop.c=FALSE,
resid=FALSE, sresid=FALSE, asresid=FALSE,
missing.include=FALSE, format=c("SAS","SPSS"))
```

p-value \< 0,05, il existe donc un lien entre la pr√©sence d'une mammite chronique et la mise √† la reproduction....

## r√©gression logistique pour identifier la pr√©sence ou non de mammite comme facteur de risque √† la non mise √† la reproduction

```{r}
# premi√®re tentative de r√©gression logistique
myreg <- glm(as.numeric(miserepro)~ early_mamchro, family= binomial, data = lac)
summary(myreg)
```

```{r simple-log-reg}
myreg <- glm(miserepro ~ early_mamchro, family= binomial(link = "logit"), data = lac)
summary(myreg)
```

On peut regarder l'odds-ratio de la mise √† la repro en fonction du statut.

```{r log-reg-OR-1}
## coefficients
coef(myreg)

## OR
exp(coef(myreg)[1])
```
Version mixed de ce mod√®le avec effet al√©atoire animal. Pas forc√©ment pertinent. Id√©alement, il faudrait mettre l'√©levage en effet al√©atoire. La colonne correspondante devra √™tre ajout√©e.

```{r mixed-log-reg}
myreg_mixed <- glmer(miserepro ~ early_mamchro + (1 | anim_id) , 
                    family= binomial(link = "logit"), data = lac)
summary(myreg_mixed)
```





Ce r√©sultat nous indique que le choix de la mise √† la reproduction est influenc√© par la pr√©sence ou non de mammite lors des 91 premiers jours de lactation. Or pour ce premier mod√®le j'ai totalement ignor√© les autres variables qui peuvent influencer ce r√©sultat comme : - la parit√© - la production laiti√®re - la pr√©sence d'une autre affection concomitante


rajout d'une nouvelle variable √† ce mod√®le : prenons le rang de lactation 

```{r}
#rajout de la variable parit√© dans la r√©gression logistique 
myreg2 <- glm(miserepro ~ early_mamchro + parity, family= binomial(link = "logit"), data = lac)
summary(myreg2)
```

Le coefficient semble logique, plus la parit√© augmente et moins la probabilit√© de mise √† la repro est √©lev√©e. On voit √©galement que la valeur est tr√®s significative 

Il faudrait √©galemement ajouter la production laiti√®re (simplement la production en kg sans prendre en compte le TB et le TP)
le probl√®me c'est que la production laiti√®re se trouve dans le data frame rec qui ne se pr√©sente pas de la m√™me mani√®re. 
Il faudrait peut-√™tre calculer la moyenne de la PL sur l'ensemble des contr√¥les fait avant 91j de lactation et se servir de la moyenne dans le calcul ? 

```{r}
#Cr√©ation d'un nouveau jeu de donn√©es qui donne la production laiti√®re moyenne par lactation
rec_plmoy_parite <- rec |> 
  group_by(anim_id, parity) |> 
  summarize(plmoy = mean(milk, na.rm = TRUE),
            herd_id = unique(herd_id))
```

```{r}
lacpl <- inner_join(lac |> 
                     select(anim_id, parity, miserepro, early_mamchro, early_plmoy), 
                   rec_plmoy_parite |> 
                     select(anim_id, herd_id, parity, plmoy),
                   join_by(anim_id, parity)) |> 
  select(herd_id, anim_id, parity, early_plmoy, plmoy, early_mamchro, miserepro)
  
```

```{r}
myreg3 <- glm(miserepro ~ early_mamchro +factor(parity) + plmoy, family= binomial(link = "logit"), data = lacpl)
summary(myreg3)
```

```{r}
#nouvelle r√©gression mais avec early_plmoy 
myreg4 <- glm(miserepro ~ early_mamchro +factor(parity) + early_plmoy, family= binomial(link = "logit"), data = lacpl)
summary(myreg4)
```


ajout de la variable al√©atoire de troupeau

```{r}
myreg_mixed2 <- glmer(miserepro ~ early_mamchro + factor(parity) + early_plmoy + (1 | herd_id), 
                    family= binomial(link = "logit"), data = lacpl)
summary(myreg_mixed2)
```

Regroupement des parit√©s selon des classes plus pertinentes : On voit que sur la r√©gression lin√©aire, le r√©sultat est significatif jusqu'a une parit√© de 10 on peut donc regrouper les classes de parit√© 9 et plus. 

```{r}
#Cr√©ation d'une nouvelle variable parit√© en 9 classes
lacpl <- lacpl |> 
  mutate(C9parite = case_when(parity == 1 ~ "1",
                            parity == 2 ~ "2",
                            parity == 3 ~ "3",
                            parity == 4 ~ "4",
                            parity == 5 ~ "5",
                            parity == 6 ~ "6",
                            parity == 7 ~ "7",
                            parity == 8 ~ "8",
                            parity >= 9 ~ "9 et plus",
                            TRUE~NA))
```
```{r}
#R√©gression logistique finale 2 pour la d√©cision de mise √† la repro
myreg_mixed3 <- glmer(miserepro ~ early_mamchro + factor(C9parite) + early_plmoy + (1 | herd_id), 
                    family= binomial(link = "logit"), data = lacpl)
summary(myreg_mixed3)
```

# Evaluation de l'impact des mammites sur la mort de l'animal 

Dans le tableau "mvt" on consid√®re M = mort et E = √©quarissage qui est √©quivalent √† mort

on consid√®re cette fois 3 types de mammites : 
-mammite chronique de d√©but de lactation (2 ctrl scc > 200 000)
-mammite chronique de fin de lactation (idem)
-mammite aigu√´ (1 scc < 200 000 suivi d'un scc > 200 000 et a nouveau suivi d'un scc < 200 000)

```{r}
str(rec)
```


```{r}
rec <- rec |> 
  group_by(anim_id, parity) 
```

```{r}
rec$scc_aig = rep(NA, nrow(rec))
```


```{r}
rec <- rec[order(rec$anim_id, rec$parity),]
```


```{r}
for(i in 2 : (nrow(rec)-1)){
    rec$scc_aig[i] = ifelse(rec$scc[i] >= 200
           & rec$scc[i-1] < 200
           & rec$scc[i+1] < 200
           & rec$anim_id[i-1] == rec$anim_id[i]
           & rec$anim_id[i] == rec$anim_id[i+1]
           & rec$parity[i-1] == rec$parity[i]
           & rec$parity[i] == rec$parity[i+1],
           1,
           0)
    }
```


```{r}

  
```

