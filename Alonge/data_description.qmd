---
title: "Description des données Alonge"
author: "Aurélien"
format: html
---

```{r setup}
#| echo: false
#| message: false
#| warning: false

library(tidyverse)
library(readxl)
library(ggplot2)
```


# Données Littoral Normand

```{r path-data-littoral-normand}
#| echo: false
path_to_data <- "data/"
```

## Evènements sanitaires

Chargement des évènements sanitaires.

```{r loading-health-recrords-data}
#| echo: false
path_to_file <- paste0(path_to_data, "20240216_bdd évènements sanitaires.xlsx")

san <- read_excel(path_to_file) |> 
  rename(dep = "Num Dép",
         herd_id = "Num Cheptel",
         anim_id = "Num National",
         lac_id = "Num Lactation",
         calv_date = "Date Début Lactation",
         event_date = "Date Sanitaire",
         LISA_code = "Code LISA",
         disease = "Nom Pathologie",
         LISA_alt = "Code Alternatif LISA",
         disease_cat = "CatégoriePathologie",
         anim_cat = "CatégorieAnimaux"
         ) |> 
  mutate(
    calv_date = as.Date(calv_date),
    event_date = as.Date(event_date)
  )

```

Ce jeu de données contient :

- Nombre d'élevages : `r length(unique(san$herd_id))`
- Nombre d'animaux : `r length(unique(san$anim_id))`
- Nombre de lactation : `r length(unique(san$lac_id))`


Le jeu de données contient les évènements sanitaires survenus entre début 2021 et début 2024.

```{r san-event-dates-summary}
summary(san$event_date)
```


```{r san-event-dates-dist}
san |> 
  # filter(calv_date > "2018-12-31") |> 
  ggplot(aes(x = event_date)) +
  geom_histogram()
```

La majorité des vaches incluses ont des dates de vêlage entre 2019 et 2024.


```{r san-calv-dates-summary}
summary(san$calv_date)
```


```{r san-calv-dates-dist}
san |> 
  filter(calv_date > "2018-12-31") |> 
  ggplot(aes(x = calv_date)) +
  geom_histogram()
```

Ci-dessous la distribution des fréquences de évènements enregistrés.

```{r}
san |> 
  select(disease) |> 
  table() |> 
  as_tibble() |> 
  arrange(desc(n)) |>
  mutate(disease = fct_reorder(disease, desc(n))) |> 
  filter(row_number()  > 0 & row_number()  < 50) |> 
  ggplot(aes(x = disease, y = n)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x=element_text(angle=90, hjust = 1)) +
  xlab("")
```

## Données mammites

```{r}

```


## Données parage

```{r}

```


# Données Idele

Les données transmises par Philippe contiennent 11 fichiers.


## Format des données

Le fichier Format_données.csv contient un descriptif des différents jeux de données.

```{r data-desc-chargment}
path_to_file <- paste0(path_to_data, "Format_données.xlsx")

data_desc <- read_excel(path_to_file)
print(data_desc)
```

## Liste des animaux

```{r ls-anim-chargment}
path_to_file <- paste0(path_to_data, "list_anim.txt")

ls_anim <- read.csv2(path_to_file)

glimpse(ls_anim)
```
## Liste des élevages

```{r ls-elv-chargment}
path_to_file <- paste0(path_to_data, "list_elev.txt")

ls_elv <- read.csv2(path_to_file)

glimpse(ls_elv)
```


## Conditions naissances

Le fichier s'appelle `condition_naiss.txt`. Il contient des informations sur des bovins, notamment des années et conditions de naissance.


```{r conditions-naiss-chargement}
path_to_file <- paste0(path_to_data, "condition_naiss.txt")

cnais <- read.csv2(path_to_file)

colnames(cnais) <- tolower(colnames(cnais))

glimpse(cnais)
```

`RV` semble contenir des rangs de vêlage.

```{r cnais-rang-velage}
barplot(table(cnais$RV))
```


Les codes et effectifs pour les conditions de naissance :

```{r cnais-conditions-naissance}
table(cnais$CN)
```
Les poids de naissance sont renseignés pour `r round(length(cnais$PONAIS[!is.na(cnais$PONAIS)]) / nrow(cnais) * 100, 1)`% des animaux Cela me semble très élevé.


```{r cnais-ditrib-poids-naiss}
hist(cnais$PONAIS)
```

## Contrôles laitiers

Le fichier est assez volumineux (241 Mo). Données classiques.

```{r controles-elementaires}
path_to_file <- paste0(path_to_data, "controle_elem.txt")

rec <- read.csv2(path_to_file)

colnames(rec) <- tolower(colnames(rec))

rec <- rec |> 
  rename(parity = nulact,
         ctrl_date = dapaul,
         dure_lac_ = dulact,
         scc = colelc)

glimpse(rec)
```

Il contient de données pour `r nrow(rec)` contrôles élemntaires sur `r  length(unique(rec$ANIM))` vaches. On remonte assez loin en termes de dates de contrôles.

```{r rec-distrib-dates}
rec |> 
  mutate(ctrl_date = as.Date(ctrl_date)) |> 
  ggplot(aes(x = ctrl_date)) +
  geom_histogram()
```

## Produtcion

Ce fichier contient moins de lignes et plus de colonnes que le précédent. Je ne comprends pas bien la différence.

```{r prd-chargment}
path_to_file <- paste0(path_to_data, "production.txt")

prd <- read.csv2(path_to_file)

colnames(prd) <- tolower(colnames(prd))

prd <- prd |> 
  rename(parity = nulact)

glimpse(prd)
```




```{r}
rec <- inner_join(rec,
                  prd |> 
                    select(anim, parity, dadela),
                  join_by(anim, parity))
 
```

```{r}
rec <- rec |> 
  mutate(dadela = as.Date(dadela), ctrl_date = as.Date(ctrl_date))


rec <- rec |> 
  mutate(dim = as.integer(ctrl_date - dadela))
```


## Inséminations artificielles

```{r ia-chargment}
path_to_file <- paste0(path_to_data, "extra_femia_20240415.csv")

ia <- read.csv(path_to_file)

colnames(ia) <- tolower(colnames(ia))

glimpse(ia)
```
## Généalogie

```{r genea-chargment}
path_to_file <- paste0(path_to_data, "genea.txt")

gna <- read.csv2(path_to_file)

colnames(gna) <- tolower(colnames(gna))

glimpse(gna)
```


## Index

```{r index-chargment}
path_to_file <- paste0(path_to_data, "index.txt")

indx <- read.csv2(path_to_file)

colnames(indx) <- tolower(colnames(indx))

glimpse(indx)
```

## Mammites

```{r mamt-chargment}
path_to_file <- paste0(path_to_data, "mammites.txt")

mamt <- read.csv2(path_to_file)

colnames(mamt)<-tolower(colnames(mamt))

glimpse(mamt)
```
- Code origine mammite

Il y a 3 codes mamites différents. Pas de description.

```{r code-mammite-desc}
mamt |> 
  select(coorco) |> 
  table()
```
- Sévérité mammites

```{r mammite-severite}
mamt |> 
  select(semacl) |> 
  table()
```
- Combinaison code - sévérité mammite

Mammites de code C globalement moins sévères.

```{r mammite-severité-code}
mamt |> 
  select(coorco, semacl) |> 
  table() |> 
  apply(1, function(x) round(x / sum(x), 3))
```
- Dates des mammites

```{r mamites-dsitribution-dates}
mamt |> 
  mutate(damacl = as.Date(damacl)) |> 
  ggplot(aes(x = damacl)) +
  geom_histogram()
```


## Mouvements

```{r mvt-chargment}
path_to_file <- paste0(path_to_data, "mvt.txt")

mvt <- read.csv2(path_to_file)

colnames(mvt) <- tolower(colnames(mvt))

glimpse(mvt)
```

# Création d'une liste de lactations 

```{r - lac-list of lactations}
lac <- rec |> 
  group_by(anim, parity) |> 
  summarize(parity = unique(parity),
            dim,
            n_ctrl = length(unique(ctrl_date)),
            frpacl,
            calv_date = dadela,
            n_scc_high = length(scc[scc > 200]),
            n_scc_early = length(scc[dim < 91]),
            n_scc_early_high = length(scc[scc > 200 & dim < 91]),
            n_scc_late_high = length(scc[scc > 200 & dim > 91]),
            early_pl = mean((lai24h[dim < 91])))



```

##Estimation de la proportion de vaches en fonction du nombre de contrôles  

```{r}
effectif_ctrl <- lac |> 
  group_by(n_ctrl) |> 
  summarize(nvaches = n())
glimpse(effectif_ctrl)


```
tableau qui ne sélectionne que les animaux qui ont plus de 9 contrôles 

HELP : j'aimerais faire un tableau simplifié avec les vaches qui ont eu plus de 9 controles et toutes les dates de vêlage après 2015 (car ici on remonte jusqu'en 1989...)
```{r}
lac_corr = (lac[lac$n_ctrl > 9 & lac$calv_date >as.Date("2015-01-01"),]
```


## ajout des données de reproduction

```{r}
calv_first <- min(lac_corr$calv_date)
```



```{r miserepro-early_mamchro-definition}
lac_corr <- lac_corr |> 
  mutate(miserepro = ifelse( == 0 | is.na(ai_N), 0, 1),
         early_mamchro = ifelse(n_scc_early_high >= 2, 1, 0))

```




