<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aurélien Madouasse">

<title>Causal analysis of the relationship between mastitis and longevity in dairy cows</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="longevity_mastitis_files/libs/clipboard/clipboard.min.js"></script>
<script src="longevity_mastitis_files/libs/quarto-html/quarto.js"></script>
<script src="longevity_mastitis_files/libs/quarto-html/popper.min.js"></script>
<script src="longevity_mastitis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="longevity_mastitis_files/libs/quarto-html/anchor.min.js"></script>
<link href="longevity_mastitis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="longevity_mastitis_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="longevity_mastitis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="longevity_mastitis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="longevity_mastitis_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Causal analysis of the relationship between mastitis and longevity in dairy cows</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Aurélien Madouasse </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In broad terms, longevity is the length of the life of an animal, although a wide variety of indicators can be used to measure it. A recent study by <span class="citation" data-cites="dallago2021">Dallago et al. (<a href="#ref-dallago2021" role="doc-biblioref">2021</a>)</span> provided evidence of a decrease in dairy cows’ longevity between the 1960s and 2010s in the top 10 high milk-producing countries.</p>
<p>The departure of a cow from her herd is called culling <span class="citation" data-cites="fetrow2006">(<a href="#ref-fetrow2006" role="doc-biblioref">Fetrow, Nordlund, and Norman 2006</a>)</span>. In some cases, the farmer has no other choice than to cull a cow, in case of death or when the cow is not pregnant and does not give enough milk anymore to be kept in the herd. This is usually called involuntary culling. In other cases, farmers choose to cull the cows for various reasons, mostly for the presence of a disease. This is called voluntary culling. The main documented causes of culling are reproductive failure, mastitis and lameness.</p>
<p>Improving dairy cows’ longevity therefore requires to act on the causes of culling. For example, if a disease is reported as a cause for culling, preventing the disease from occurring should increase longevity. However, this is a notably hard task. The decision of culling a cow may depend on several combined causes that are related to the status of a given animal as well as on the farm context. Furthermore, disease incidence may be increased by the presence of risk factors, and, disease occurrence can also act on factors such as milk production or reproduction that are sufficient reasons for culling. Lastly, for contagious diseases, culling infected cows could reduce the incidence of the disease by removing sources of infection from the herd.</p>
<p>Our objective in this paper is to analyse longevity and disease occurrence in a causal framework, using mastitis in dairy cows as an example.</p>
</section>
<section id="introduction-1" class="level1">
<h1>Introduction</h1>
<section id="causal-framework" class="level2">
<h2 class="anchored" data-anchor-id="causal-framework">Causal framework</h2>
<p>Determining what causes what is an important question in many fields. Philosophers and scientists have come up with various ways of addressing it. In quantitative disciplines such as epidemiology, economics and sociology, the 2 paradigms currently in use are the <em>potential outcomes framework</em> who is associated with Donald Rubin <span class="citation" data-cites="rubin1974">(<a href="#ref-rubin1974" role="doc-biblioref">Rubin 1974</a>)</span> and <em>structural causal models</em> proposed by Judea Pearl <span class="citation" data-cites="pearl2009">(<a href="#ref-pearl2009" role="doc-biblioref"><strong>pearl2009?</strong></a>)</span>. Although the 2 paradigms seem to differ in important ways <span class="citation" data-cites="markus2021">(<a href="#ref-markus2021" role="doc-biblioref"><strong>markus2021?</strong></a>)</span>, they are sometimes presented as part of a single causality framework in textbooks <span class="citation" data-cites="neal2020 cunningham2021">(<a href="#ref-neal2020" role="doc-biblioref"><strong>neal2020?</strong></a>; <a href="#ref-cunningham2021" role="doc-biblioref"><strong>cunningham2021?</strong></a>)</span>. In what follows, we frame our problem using the potential outcomes framework and then decompose it using directed acyclic graphs, most commonly associated with the structural causal framework. Our objectives are to make sound causal inference while keeping the presentation of our research questions to the readers as clear as possible.</p>
</section>
<section id="potential-outcomes-framework" class="level2">
<h2 class="anchored" data-anchor-id="potential-outcomes-framework">Potential outcomes framework</h2>
<p>Estimating the causal effect of the occurrence of an event on an outcome requires to be able to compare the outcome values with and without the event. For example, estimating the effect of mastitis occurrence on the probability of culling in a given cow would require to be able to observe the same cow with and without mastitis and record whether she is culled or not following the disease or its absence. Such data is of course impossible to obtain. This is in fact called <em>the fundamental problem of causal inference</em>. But laying out the problem in these terms can help to clarify the research questions, design experiments, analyse the data and interpret the results. <span class="citation" data-cites="hernan2024">Hernan and Robins (<a href="#ref-hernan2024" role="doc-biblioref">2024</a>)</span> describe in simple terms and introduce notation for the potential outcome framework, that was developed by several scientists over the course of the XX<span class="math inline">\(^{th}\)</span> century, notably Donald Rubin <span class="citation" data-cites="rubin1974">(<a href="#ref-rubin1974" role="doc-biblioref">Rubin 1974</a>)</span>. Let us introduce this notation using the causal effect of mastitis on the probability of culling in a cow as an example. We consider mastitis occurrence as a binary event <span class="math inline">\(A\)</span> with <span class="math inline">\(A=1\)</span> denoting presence of mastitis and <span class="math inline">\(A=0\)</span> denoting the absence of mastitis. We are interested in what would happen in cow <span class="math inline">\(i\)</span> if she were to experience mastitis (<span class="math inline">\(Y_i^{1}\)</span>) or, on the contrary, if she weren’t experiencing mastitis (<span class="math inline">\(Y_i^{0}\)</span>). <span class="math inline">\(Y_i^{A}\)</span> represents whether cow <span class="math inline">\(i\)</span> is culled or not at the end of her lactation, with <span class="math inline">\(Y^{A=a}_i=1\)</span> if cow <span class="math inline">\(i\)</span> is culled and <span class="math inline">\(Y^{A=a}_i=0\)</span> if cow <span class="math inline">\(i\)</span> is not culled, when event <span class="math inline">\(A=a\)</span> occurs. In a given cow, only one event <span class="math inline">\(A=a\)</span> and its associated outcome <span class="math inline">\(Y^{A=a}\)</span> can be observed. These event and outcome are called factual, and the unobserved ones are called counterfactual. The factual (realised) outcomes are encoded using the <span class="math inline">\(|\)</span> symbol. For example, <span class="math inline">\(Y_i | A = 0\)</span> is the observed outcome for cow <span class="math inline">\(i\)</span> who did not get mastitis. Problems arise when there are systematic differences in potential outcomes between treated and untreated individuals, for example if <span class="math inline">\(Y^{A = 1}|A = 1 \neq Y^{A = 1}|A = 0\)</span>.</p>
</section>
<section id="estimands-the-quantities-of-interest" class="level2">
<h2 class="anchored" data-anchor-id="estimands-the-quantities-of-interest">Estimands: the quantities of interest</h2>
<p>Estimands are quantities whose value is the answer to a precise research question. Estimands are independent of both the data available and the estimation method used for the analysis. They are used in slightly different ways in different disciplines (see for example the different perspectives in sociology in <span class="citation" data-cites="lundberg2021a">(<a href="#ref-lundberg2021a" role="doc-biblioref"><strong>lundberg2021a?</strong></a>)</span> and in randomized clinical trials in <span class="citation" data-cites="kahan2024">Kahan et al. (<a href="#ref-kahan2024" role="doc-biblioref">2024</a>)</span> ). Following <span class="citation" data-cites="lundberg2021a">(<a href="#ref-lundberg2021a" role="doc-biblioref"><strong>lundberg2021a?</strong></a>)</span>, the two minimum components of an estimand are a <em>unit-specific quantity</em> and a <em>target population</em> <span class="citation" data-cites="lundberg2021">(<a href="#ref-lundberg2021" role="doc-biblioref">Lundberg, Johnson, and Stewart 2021</a>)</span>. These authors make a further distinction between theoretical estimands which are the quantities of interest to the researchers and empirical estimands which are approximations that can be computed from observed data.</p>
<p>For example, if we wanted to know the causal effect of clinical mastitis in early lactation on the probability of culling before or at the end of lactation in French dairy cows, we could define the following theoretical estimand:</p>
<p><span class="math display">\[
\delta_1 = \frac{1}{n} \sum_{i=1}^n Y^{1}_i - Y^{0}_i
\]</span> where <span class="math inline">\(n\)</span> is the total number of cows in the French dairy cow population, <span class="math inline">\(Y^1_i\)</span> and <span class="math inline">\(Y^0_i\)</span> are binary variables taking the value 1 for cows culled at or before the end of lactation and 0 otherwise in cows with (<span class="math inline">\(Y^1_i\)</span> ) and without (<span class="math inline">\(Y^0_i\)</span>) clinical mastitis in early lactation respectively. Of course, in each cow, only one of the 2 outcomes can be observed. This estimand is a risk difference, but risk ratios or odds ratios could have been used as well.</p>
<p>But maybe, the cows who got mastitis are different from the cows who did not, for reasons other than having experienced the disease, and therefore have a different probability of being culled. <span class="math inline">\(Y^{A=a}_i|A=1\)</span> denotes the outcome associated with having mastitis given that animal <span class="math inline">\(i\)</span> experienced mastitis. We could make the hypothesis that <span class="math inline">\(Y^1_i|A=1 \neq Y^1_i|A=0\)</span> and choose to focus our interest on cows who actually got mastitis. A theoretical estimand of interest in this situation could be: <span class="math display">\[
\delta_2 = \frac{1}{n} \sum_{i=1}^n \left[ (Y^{1}_i|A=1) - (Y^{0}_i|A=1) \right]
\]</span></p>
<p><span class="math inline">\(\delta_1\)</span> is called the average treatment effect (<strong>ATE</strong>). It is a measure of a treatment (in our case a disease) effect in the whole population. <span class="math inline">\(\delta_2\)</span> is called the average treatment effect in the treated (<strong>ATT</strong>). In our case, it is more relevant to consider the ATE, since our interest is in evaluating the consequences of preventing mastitis in cows who experienced the disease, not really on the whole population.</p>
</section>
<section id="directed-acyclic-graphs" class="level2">
<h2 class="anchored" data-anchor-id="directed-acyclic-graphs">Directed acyclic graphs</h2>
<p>Directed acyclic graphs, commonly called <strong>DAG</strong>s, are graphical representations of a phenomenon which are particularly well suited to model causality. The different parts or components of the phenomenon are represented using circles called nodes. We can represent the hypothesis that mastitis (<span class="math inline">\(M\)</span>) causes culling (<span class="math inline">\(C\)</span>) as follows:</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="longevity_mastitis_files/figure-html/dag1-1.png" class="img-fluid" width="288"></p>
</div>
</div>
<p>where the arrow indicates causality. DAGs allow to represent complex relationships between variables. We now provide a few examples of how DAGs can be useful to get a better picture of causal relationship.</p>
<p>Mastitis could have both direct and indirect effects on culling. As a direct effect, a severe case of clinical mastitis can lead to the death of the cow. As an indirect effect, mastitis could compromise reproductive success. This indirect effect of mastitis is <em>mediated</em> by reproduction. One usual way of modelling such data would be to fit a logistic model with culling as the outcome and mastitis and reproduction as covariates. However, if there is an effect of mastitis on reproduction, the true causal effect of mastitis on culling by the logistic model will be underestimated, because part of if will be incorporated into the effect of reproduction on culling.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="longevity_mastitis_files/figure-html/dag2-1.png" class="img-fluid" width="288"></p>
</div>
</div>
</section>
<section id="definition-of-mastitis" class="level2">
<h2 class="anchored" data-anchor-id="definition-of-mastitis">Definition of mastitis</h2>
<p>Mastitis is an inflammation of a mammary gland, caused by an intramammary infection. Different aetiological agents are associated with differences in disease epidemiology. On the one hand, bacteria of faecal origin such as <em>Escherichia coli</em> cause short lived infections with a high rate of spontaneous cure, but often acute clinical signs. On the other hand, some bacteria, such as <em>Staphylococcus aureus</em> are adapted to survive in the mammary gland and are associated with chronic infections. In this case, the infection can last for months, with clinical signs observed on rare occasions with regards with the duration of the infection. Because bacteria are shed in the milk of infected cows for long periods, milk is more likely to serve as a reservoir of infection. These infections are therefore described as contagious. All infections result in the recruitment of immune cells in the mammary gland, that are measured on a monthly basis in herds that participate to milk recording. The measured cell concentration is called milk somatic count (<strong>SCC</strong>).</p>
<p>In this study, we chose to consider the following types of mastitis:</p>
<ul>
<li>new case of contagious mastitis in early lactation: primiparous cow with at least 2 out of the first 3 milk recordings above 200 000 cells/mL or multiparous cow with the last milk recording in her previous lactation below 200 000 cells/mL and at least 2 out of the first 3 milk recordings above 200 000 cells/mL</li>
<li>environmental mastitis in early lactation</li>
</ul>
</section>
<section id="definition-of-culling" class="level2">
<h2 class="anchored" data-anchor-id="definition-of-culling">Definition of culling</h2>
</section>
<section id="hypohteses-and-dag" class="level2">
<h2 class="anchored" data-anchor-id="hypohteses-and-dag">Hypohteses and DAG</h2>
</section>
</section>
<section id="data-analysis" class="level1">
<h1>Data analysis</h1>
<p>Unité statistique = lactation Y = réforme &lt;-&gt; revêlage</p>
<p>Using the <code>DairyHerdData</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## milk recording data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">&lt;-</span> rec</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">## artificial insemination data</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>ai <span class="ot">&lt;-</span> ai <span class="sc">|&gt;</span> </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ai_date =</span> <span class="fu">as.Date</span>(ai_date))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="do">## days in milk added to milk recording data</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">&lt;-</span> rec <span class="sc">|&gt;</span> </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dim =</span> <span class="fu">as.integer</span>(ctrl_date <span class="sc">-</span> calv_date))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="do">## making a list of lactations</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>lac <span class="ot">&lt;-</span> rec <span class="sc">|&gt;</span> </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(anim_id, calv_date) <span class="sc">|&gt;</span> </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lac_id =</span> <span class="cn">NA</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">parity =</span> <span class="fu">unique</span>(parity),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_ctrl =</span> <span class="fu">length</span>(<span class="fu">unique</span>(ctrl_date)),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_scc_high =</span> <span class="fu">length</span>(scc[scc <span class="sc">&gt;</span> <span class="dv">200</span>]),</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_scc_early =</span> <span class="fu">length</span>(dim[dim <span class="sc">&lt;</span> <span class="dv">91</span>]),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_scc_early_high =</span> <span class="fu">length</span>(scc[scc <span class="sc">&gt;</span> <span class="dv">200</span> <span class="sc">&amp;</span> dim <span class="sc">&lt;</span> <span class="dv">91</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'anim_id'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>lac<span class="sc">$</span>lac_id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(lac)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>lac <span class="ot">&lt;-</span> lac <span class="sc">|&gt;</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(anim_id) <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calv_nxt =</span> <span class="fu">lead</span>(calv_date))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="do">## first date of calving</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>calv_first <span class="ot">&lt;-</span> <span class="fu">min</span>(lac<span class="sc">$</span>calv_date)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>ai <span class="ot">&lt;-</span> ai <span class="sc">|&gt;</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ai_date <span class="sc">&gt;</span> calv_first)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>ai1 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(lac <span class="sc">|&gt;</span> </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">select</span>(anim_id, lac_id, calv_date, calv_nxt), </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                 ai <span class="sc">|&gt;</span> </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">select</span>(herd_id, cow_id, ai_date),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">join_by</span>(anim_id <span class="sc">==</span> cow_id)) <span class="sc">|&gt;</span> </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>           <span class="fu">filter</span>(ai_date <span class="sc">&gt;</span> calv_date <span class="sc">&amp;</span> (ai_date <span class="sc">&lt;</span> calv_nxt <span class="sc">|</span> <span class="fu">is.na</span>(calv_nxt))) <span class="sc">|&gt;</span> </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(herd_id, anim_id, lac_id, calv_date, calv_nxt, ai_date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in left_join(select(lac, anim_id, lac_id, calv_date, calv_nxt), : Detected an unexpected many-to-many relationship between `x` and `y`.
ℹ Row 1 of `x` matches multiple rows in `y`.
ℹ Row 6 of `y` matches multiple rows in `x`.
ℹ If a many-to-many relationship is expected, set `relationship =
  "many-to-many"` to silence this warning.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ai_lac <span class="ot">&lt;-</span> ai1 <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(lac_id, ai_date) <span class="sc">|&gt;</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lac_id) <span class="sc">|&gt;</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ai_N =</span> <span class="fu">length</span>(<span class="fu">unique</span>(ai_date)),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">ai_first =</span> <span class="fu">min</span>(ai_date),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">ai_last =</span> <span class="fu">max</span>(ai_date),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">ai_calv_days =</span> <span class="fu">as.integer</span>(<span class="fu">unique</span>(calv_nxt) <span class="sc">-</span> <span class="fu">max</span>(ai_date)))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>lac <span class="ot">&lt;-</span> <span class="fu">left_join</span>(lac, ai_lac)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(lac_id)`</code></pre>
</div>
</div>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-dallago2021" class="csl-entry" role="listitem">
Dallago, Gabriel M., Kevin M. Wade, Roger I. Cue, J T. McClure, René Lacroix, Doris Pellerin, and Elsa Vasseur. 2021. <span>“Keeping Dairy Cows for Longer: A Critical Literature Review on Dairy Cow Longevity in High Milk-Producing Countries.”</span> <em>Animals</em> 11 (3): 808. <a href="https://doi.org/10.3390/ani11030808">https://doi.org/10.3390/ani11030808</a>.
</div>
<div id="ref-fetrow2006" class="csl-entry" role="listitem">
Fetrow, J., K. V. Nordlund, and H. D. Norman. 2006. <span>“Invited Review: Culling: Nomenclature, Definitions, and Recommendations.”</span> <em>Journal of Dairy Science</em> 89 (6): 1896–1905. <a href="https://doi.org/10.3168/jds.S0022-0302(06)72257-3">https://doi.org/10.3168/jds.S0022-0302(06)72257-3</a>.
</div>
<div id="ref-hernan2024" class="csl-entry" role="listitem">
Hernan, Miguel A, and James M Robins. 2024. <em>Causal Inference: What If</em>. First edition. Boca Raton: CRC Press. <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/">https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/</a>.
</div>
<div id="ref-kahan2024" class="csl-entry" role="listitem">
Kahan, Brennan C., Joanna Hindley, Mark Edwards, Suzie Cro, and Tim P. Morris. 2024. <span>“The Estimands Framework: A Primer on the ICH E9(R1) Addendum.”</span> <em>BMJ</em> 384 (January): e076316. <a href="https://doi.org/10.1136/bmj-2023-076316">https://doi.org/10.1136/bmj-2023-076316</a>.
</div>
<div id="ref-lundberg2021" class="csl-entry" role="listitem">
Lundberg, Ian, Rebecca Johnson, and Brandon M. Stewart. 2021. <span>“What Is Your Estimand? Defining the Target Quantity Connects Statistical Evidence to Theory.”</span> <em>American Sociological Review</em> 86 (3): 532–65. <a href="https://doi.org/10.1177/00031224211004187">https://doi.org/10.1177/00031224211004187</a>.
</div>
<div id="ref-rubin1974" class="csl-entry" role="listitem">
Rubin, Donald B. 1974. <span>“Estimating Causal Effects of Treatments in Randomized and Nonrandomized Studies.”</span> <em>Journal of Educational Psychology</em> 66 (5): 688–701. <a href="https://doi.org/10.1037/h0037350">https://doi.org/10.1037/h0037350</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>